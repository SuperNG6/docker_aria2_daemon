#!/usr/bin/with-contenv bash
# /etc/cont-init.d/30-config
# 初始化和更新配置文件：适配 /aria2/scripts/actions 路径

set -euo pipefail

# 引入模块
. /aria2/scripts/core/logging.sh

log_info "开始更新 /config/aria2.conf 配置文件..."

# -----------------------------
# 1) 更新事件脚本路径
# -----------------------------
log_info "更新事件脚本路径到 /aria2/scripts/actions..."
sed -i 's@^\(on-download-stop=\).*@\1/aria2/scripts/actions/stop.sh@' /config/aria2.conf
sed -i 's@^\(on-download-complete=\).*@\1/aria2/scripts/actions/completed.sh@' /config/aria2.conf
sed -i 's@^\(on-download-pause=\).*@\1/aria2/scripts/actions/pause.sh@' /config/aria2.conf
sed -i 's@^\(on-download-start=\).*@\1/aria2/scripts/actions/start.sh@' /config/aria2.conf

# -----------------------------
# 2) 更新端口配置
# -----------------------------
log_info "更新端口配置..."
sed -i "s@^\(rpc-listen-port=\).*@\1${PORT}@" /config/aria2.conf
sed -i "s@^\(dht-listen-port=\).*@\1${BTPORT}@" /config/aria2.conf
sed -i "s@^\(listen-port=\).*@\1${BTPORT}@" /config/aria2.conf

# -----------------------------
# 3) 更新 BT 保存元数据选项
# -----------------------------
log_info "更新 bt-save-metadata 设置..."
if [[ "$SMD" == "true" ]]; then
    sed -i 's@^\(bt-save-metadata=\).*@\1true@' /config/aria2.conf
else
    sed -i 's@^\(bt-save-metadata=\).*@\1false@' /config/aria2.conf
fi

# -----------------------------
# 4) 更新文件分配策略
# -----------------------------
log_info "更新文件分配策略 (file-allocation)..."
case "$FA" in
    "falloc")
        sed -i 's@^\(file-allocation=\).*@\1falloc@' /config/aria2.conf
        ;;
    "trunc")
        sed -i 's@^\(file-allocation=\).*@\1trunc@' /config/aria2.conf
        ;;
    "prealloc")
        sed -i 's@^\(file-allocation=\).*@\1prealloc@' /config/aria2.conf
        ;;
    *)
        sed -i 's@^\(file-allocation=\).*@\1none@' /config/aria2.conf
        ;;
esac

# -----------------------------
# 5) 自动更新 Tracker
# -----------------------------
log_info "检查自动更新 Tracker 配置..."
if [[ "$UT" == "true" ]]; then
    log_info "执行自动更新 Tracker 脚本..."
    bash /aria2/scripts/tracker/tracker.sh
else
    log_info "跳过自动更新 Tracker。"
fi

# -----------------------------
# 6) 更新 RPC Tracker 定时任务
# -----------------------------
log_info "更新 RPC Tracker 定时任务..."
if [[ "$RUT" == "true" ]]; then
    cp /aria2/conf/rpc-tracker1 /etc/crontabs/root
    /usr/sbin/crond
    log_info "已启用 RPC Tracker 定时任务。"
else
    cp /aria2/conf/rpc-tracker0 /etc/crontabs/root
    log_info "已禁用 RPC Tracker 定时任务。"
fi

log_info "30-config 脚本执行完成：aria2.conf 配置已更新。"